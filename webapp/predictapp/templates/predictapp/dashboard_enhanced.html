{% extends 'predictapp/base_enhanced.html' %}

{% block title %}SignSpeak - Your Learning Adventure! üöÄ{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <!-- Welcome Hero Section -->
    <div class="text-center mb-16 animate__animated animate__fadeInDown">
        <div class="relative inline-block mb-8 px-4">
            <h1 class="text-7xl font-black text-gradient mb-4 floating leading-tight">
                Learning Dashboard
            </h1>
            <div class="absolute -top-4 -right-4 text-4xl animate-bounce">üöÄ</div>
            <div class="absolute -bottom-4 -left-4 text-3xl wiggle">üéØ</div>
        </div>
        <p class="text-2xl text-gray-600 dark:text-gray-300 max-w-4xl mx-auto leading-relaxed">
            üéâ Welcome to your personalized ASL learning adventure! Track your progress, play games, and become a signing superstar! ‚ú®
        </p>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
        <div class="glass-morphism rounded-3xl p-8 text-center shadow-xl card-hover animate__animated animate__fadeInUp neon-glow">
            <div class="relative inline-block mb-6">
                <div class="w-20 h-20 gradient-primary rounded-2xl flex items-center justify-center mx-auto shadow-xl floating">
                    <i class="fas fa-bolt text-3xl text-white wiggle"></i>
                </div>
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full animate-ping"></div>
            </div>
            <div class="text-4xl font-black text-gradient mb-2" id="xpPoints">0</div>
            <div class="text-gray-600 dark:text-gray-400 font-bold">XP Points ‚ö°</div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-500">Keep learning!</div>
        </div>
        
        <div class="glass-morphism rounded-3xl p-8 text-center shadow-xl card-hover animate__animated animate__fadeInUp animate__delay-1s">
            <div class="relative inline-block mb-6">
                <div class="w-20 h-20 gradient-secondary rounded-2xl flex items-center justify-center mx-auto shadow-xl floating">
                    <i class="fas fa-fire text-3xl text-white pulse-slow"></i>
                </div>
                <div class="absolute -bottom-2 -left-2 text-2xl animate-bounce">üî•</div>
            </div>
            <div class="text-4xl font-black text-gradient mb-2" id="currentStreak">0</div>
            <div class="text-gray-600 dark:text-gray-400 font-bold">Current Streak üî•</div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-500">On fire!</div>
        </div>
        
        <div class="glass-morphism rounded-3xl p-8 text-center shadow-xl card-hover animate__animated animate__fadeInUp animate__delay-2s">
            <div class="relative inline-block mb-6">
                <div class="w-20 h-20 gradient-success rounded-2xl flex items-center justify-center mx-auto shadow-xl floating">
                    <i class="fas fa-trophy text-3xl text-white wiggle"></i>
                </div>
                <div class="absolute -top-2 -right-2 text-xl animate-bounce">üèÜ</div>
            </div>
            <div class="text-4xl font-black text-gradient mb-2" id="longestStreak">0</div>
            <div class="text-gray-600 dark:text-gray-400 font-bold">Best Streak üèÜ</div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-500">Personal record!</div>
        </div>
        
        <div class="glass-morphism rounded-3xl p-8 text-center shadow-xl card-hover animate__animated animate__fadeInUp animate__delay-3s">
            <div class="relative inline-block mb-6">
                <div class="w-20 h-20 gradient-warning rounded-2xl flex items-center justify-center mx-auto shadow-xl floating">
                    <i class="fas fa-chart-line text-3xl text-white pulse-slow"></i>
                </div>
                <div class="absolute -bottom-2 -right-2 w-4 h-4 bg-green-400 rounded-full animate-ping"></div>
            </div>
            <div class="text-4xl font-black text-gradient mb-2" id="weeklyXP">0</div>
            <div class="text-gray-600 dark:text-gray-400 font-bold">Weekly XP üìä</div>
            <div class="mt-2 text-xs text-gray-500 dark:text-gray-500">This week's progress!</div>
        </div>
    </div>

    <!-- Games Section -->
    <div class="glass-morphism rounded-3xl p-12 mb-16 shadow-2xl neon-glow animate__animated animate__fadeInUp">
        <div class="text-center mb-12">
            <h2 class="text-5xl font-black text-gradient mb-4 floating">
                Learning Games üéÆ
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-300">Choose your adventure and level up your ASL skills!</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <a href="/sign-race/" class="relative group cursor-pointer block">
                <div class="absolute inset-0 gradient-primary rounded-3xl blur opacity-75 group-hover:opacity-100 transition duration-300"></div>
                <div class="relative gradient-primary text-white p-8 rounded-3xl shadow-2xl transform transition-all duration-300 hover:scale-105 card-hover">
                    <div class="text-center">
                        <div class="text-6xl mb-6 floating">üèÉ‚ôÇÔ∏è</div>
                        <h3 class="text-2xl font-bold mb-3">Sign Race</h3>
                        <p class="text-sm opacity-90 mb-4">Guess ASL signs as fast as you can!</p>
                        <div class="flex justify-center space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            </a>
            
            <a href="/memory-match/" class="relative group cursor-pointer block">
                <div class="absolute inset-0 gradient-secondary rounded-3xl blur opacity-75 group-hover:opacity-100 transition duration-300"></div>
                <div class="relative gradient-secondary text-white p-8 rounded-3xl shadow-2xl transform transition-all duration-300 hover:scale-105 card-hover">
                    <div class="text-center">
                        <div class="text-6xl mb-6 wiggle">üß†</div>
                        <h3 class="text-2xl font-bold mb-3">Memory Match</h3>
                        <p class="text-sm opacity-90 mb-4">Match ASL signs with letters!</p>
                        <div class="flex justify-center space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            </a>
            
            <a href="/daily-learning/" class="relative group cursor-pointer block">
                <div class="absolute inset-0 gradient-success rounded-3xl blur opacity-75 group-hover:opacity-100 transition duration-300"></div>
                <div class="relative gradient-success text-white p-8 rounded-3xl shadow-2xl transform transition-all duration-300 hover:scale-105 card-hover">
                    <div class="text-center">
                        <div class="text-6xl mb-6 pulse-slow">üìö</div>
                        <h3 class="text-2xl font-bold mb-3">Daily Learning</h3>
                        <p class="text-sm opacity-90 mb-4">Learn new signs every day!</p>
                        <div class="flex justify-center space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                        </div>
                    </div>
                </div>
            </a>
            
            <div class="relative group cursor-pointer" onclick="startRealTimeDetection()">
                <div class="absolute inset-0 gradient-warning rounded-3xl blur opacity-75 group-hover:opacity-100 transition duration-300"></div>
                <div class="relative gradient-warning text-white p-8 rounded-3xl shadow-2xl transform transition-all duration-300 hover:scale-105 card-hover">
                    <div class="text-center">
                        <div class="text-6xl mb-6 floating">üìπ</div>
                        <h3 class="text-2xl font-bold mb-3">ASL Model</h3>
                        <p class="text-sm opacity-90 mb-4">Use AI recognition magic!</p>
                        <div class="flex justify-center space-x-1">
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.15s"></div>
                            <div class="w-2 h-2 bg-white rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements & Leaderboard Grid -->
    <div class="grid lg:grid-cols-2 gap-12 mb-16">
        <!-- Achievements Section -->
        <div class="glass-morphism rounded-3xl p-10 shadow-2xl animate__animated animate__fadeInLeft">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-black text-gradient mb-4 flex items-center justify-center">
                    <i class="fas fa-medal text-yellow-500 mr-3 wiggle"></i>
                    Achievements üèÖ
                </h2>
                <p class="text-gray-600 dark:text-gray-300">Your collection of awesome badges!</p>
            </div>
            
            <div class="grid grid-cols-2 gap-6" id="achievementsGrid">
                <!-- Default achievement cards -->
                <div class="glass-morphism p-6 rounded-2xl text-center card-hover">
                    <div class="text-4xl mb-3 animate-bounce">üèÜ</div>
                    <div class="font-bold text-sm text-gray-600 dark:text-gray-400">First Steps</div>
                </div>
                <div class="glass-morphism p-6 rounded-2xl text-center card-hover opacity-50">
                    <div class="text-4xl mb-3">‚ö°</div>
                    <div class="font-bold text-sm text-gray-600 dark:text-gray-400">Speed Demon</div>
                </div>
                <div class="glass-morphism p-6 rounded-2xl text-center card-hover opacity-50">
                    <div class="text-4xl mb-3">üî•</div>
                    <div class="font-bold text-sm text-gray-600 dark:text-gray-400">Streak Master</div>
                </div>
                <div class="glass-morphism p-6 rounded-2xl text-center card-hover opacity-50">
                    <div class="text-4xl mb-3">üéØ</div>
                    <div class="font-bold text-sm text-gray-600 dark:text-gray-400">Perfect Shot</div>
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="glass-morphism rounded-3xl p-10 shadow-2xl animate__animated animate__fadeInRight">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-black text-gradient mb-4 flex items-center justify-center">
                    <i class="fas fa-crown text-yellow-500 mr-3 floating"></i>
                    Leaderboard üëë
                </h2>
                <p class="text-gray-600 dark:text-gray-300">Top performers this week!</p>
            </div>
            
            <div id="leaderboardContainer" class="space-y-4">
                <!-- Default leaderboard entries -->
                <div class="flex items-center justify-between p-4 glass-morphism rounded-2xl card-hover">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 gradient-primary rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                            1
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 dark:text-white">You!</div>
                            <div class="text-xs text-gray-500">Keep going! üöÄ</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-purple-600 dark:text-purple-400">Loading...</div>
                        <div class="text-xs text-gray-500">XP</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="glass-morphism rounded-3xl p-12 shadow-2xl neon-glow animate__animated animate__fadeInUp">
        <div class="text-center mb-12">
            <h2 class="text-5xl font-black text-gradient mb-4 floating">
                Learning Progress üìà
            </h2>
            <p class="text-xl text-gray-600 dark:text-gray-300">Track your journey to ASL mastery!</p>
        </div>
        
        <div id="progressContainer" class="space-y-8">
            <!-- Default progress items -->
            <div class="glass-morphism p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold text-gray-800 dark:text-white text-lg">Basic Letters A-M</span>
                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">Loading...</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div class="gradient-primary h-4 rounded-full transition-all duration-1000 animate-pulse" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Game Modal -->
<div id="gameModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="glass-morphism rounded-3xl p-10 max-w-lg w-full text-center shadow-2xl neon-glow animate__animated animate__zoomIn">
        <button class="absolute top-6 right-6 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl transition-colors" onclick="closeModal()">
            <i class="fas fa-times"></i>
        </button>
        <div id="gameContent">
            <!-- Game content will be loaded here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentUser = null;
    let gameData = null;
    let gameTimer = null;
    let gameStartTime = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        updateDailyStreak();
        loadDashboard();
        addFunInteractions();
    });
    
    function updateDailyStreak() {
        const today = new Date().toDateString();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();
        
        let streakData = JSON.parse(localStorage.getItem('userStreak') || '{}');
        
        if (!streakData.lastLoginDate) {
            streakData = {
                currentStreak: 1,
                longestStreak: 1,
                lastLoginDate: today,
                totalDays: 1
            };
        } else if (streakData.lastLoginDate === today) {
            return streakData;
        } else if (streakData.lastLoginDate === yesterdayStr) {
            streakData.currentStreak += 1;
            streakData.longestStreak = Math.max(streakData.longestStreak, streakData.currentStreak);
            streakData.lastLoginDate = today;
            streakData.totalDays += 1;
        } else {
            streakData.currentStreak = 1;
            streakData.lastLoginDate = today;
            streakData.totalDays += 1;
        }
        
        localStorage.setItem('userStreak', JSON.stringify(streakData));
        return streakData;
    }

    async function loadDashboard() {
        try {
            const response = await fetch('/api/gamification/dashboard/', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                updateDashboard(data);
            } else {
                console.error('Failed to load dashboard');
                // Show default encouraging message
                showEncouragingMessage();
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showEncouragingMessage();
        }
    }

    function showEncouragingMessage() {
        // Load real streak data from localStorage
        const streakData = JSON.parse(localStorage.getItem('userStreak') || '{}');
        const gameStats = JSON.parse(localStorage.getItem('gameStats') || '{}');
        
        document.getElementById('xpPoints').textContent = gameStats.totalXP || '0';
        document.getElementById('currentStreak').textContent = streakData.currentStreak || '0';
        document.getElementById('longestStreak').textContent = streakData.longestStreak || '0';
        document.getElementById('weeklyXP').textContent = calculateWeeklyXP();
    }
    
    function calculateWeeklyXP() {
        const gameStats = JSON.parse(localStorage.getItem('gameStats') || '{}');
        const weeklyStats = JSON.parse(localStorage.getItem('weeklyStats') || '{}');
        const currentWeek = getWeekNumber(new Date());
        
        if (weeklyStats.week === currentWeek) {
            return weeklyStats.xp || 0;
        }
        return 0;
    }
    
    function getWeekNumber(date) {
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
    }

    function updateDashboard(data) {
        // Animate number updates
        animateNumber('xpPoints', data.user_stats.xp_points);
        animateNumber('currentStreak', data.user_stats.current_streak);
        animateNumber('longestStreak', data.user_stats.longest_streak);
        animateNumber('weeklyXP', data.user_stats.weekly_xp);

        // Update achievements with animations
        const achievementsGrid = document.getElementById('achievementsGrid');
        achievementsGrid.innerHTML = '';
        
        data.achievements.forEach((achievement, index) => {
            const achievementCard = document.createElement('div');
            achievementCard.className = 'glass-morphism p-6 rounded-2xl text-center card-hover animate__animated animate__bounceIn';
            achievementCard.style.animationDelay = `${index * 0.1}s`;
            achievementCard.innerHTML = `
                <div class="text-4xl mb-3 animate-bounce">${achievement.icon}</div>
                <div class="font-bold text-sm text-gray-800 dark:text-white">${achievement.name}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${achievement.description}</div>
            `;
            achievementsGrid.appendChild(achievementCard);
        });

        // Update progress with game-based data
        updateLearningProgress(data);

        // Load leaderboard
        loadLeaderboard();
    }

    function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const startValue = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function updateNumber(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
            
            element.textContent = currentValue.toLocaleString();
            
            if (progress < 1) {
                requestAnimationFrame(updateNumber);
            }
        }
        
        requestAnimationFrame(updateNumber);
    }

    async function loadLeaderboard() {
        try {
            const response = await fetch('/api/gamification/leaderboard/?period=weekly', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                const leaderboardContainer = document.getElementById('leaderboardContainer');
                leaderboardContainer.innerHTML = '';
                
                data.forEach((entry, index) => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-4 glass-morphism rounded-2xl card-hover animate__animated animate__fadeInUp';
                    item.style.animationDelay = `${index * 0.1}s`;
                    
                    const rankColors = ['gradient-primary', 'gradient-secondary', 'gradient-success'];
                    const rankClass = index < 3 ? rankColors[index] : 'bg-gray-400';
                    
                    item.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 ${rankClass} rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                                ${entry.rank}
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 dark:text-white">${entry.username}</div>
                                <div class="text-xs text-gray-500">Level ${entry.level}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-purple-600 dark:text-purple-400">${entry.total_xp}</div>
                            <div class="text-xs text-gray-500">XP</div>
                        </div>
                    `;
                    leaderboardContainer.appendChild(item);
                });
            }
        } catch (error) {
            console.error('Error loading leaderboard:', error);
        }
    }

    async function startGame(gameMode) {
        try {
            const response = await fetch('/api/gamification/start-game/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify({ game_mode: gameMode })
            });

            if (response.ok) {
                gameData = await response.json();
                showGameModal(gameMode);
            }
        } catch (error) {
            console.error('Error starting game:', error);
        }
    }

    function showGameModal(gameMode) {
        const modal = document.getElementById('gameModal');
        const gameContent = document.getElementById('gameContent');
        
        if (gameMode === 'sign_race') {
            gameContent.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-6 animate-bounce">üèÉ‚ôÇÔ∏è</div>
                    <h2 class="text-3xl font-bold text-gradient mb-4">Sign Race Challenge!</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-8">${gameData.instructions}</p>
                    <div class="glass-morphism p-6 rounded-2xl mb-8">
                        <div class="text-5xl font-bold text-gradient mb-4" id="currentLetter">${gameData.challenge[0]}</div>
                        <div class="flex justify-center space-x-8 mb-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="timer">60</div>
                                <div class="text-sm text-gray-500">Seconds</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="score">0</div>
                                <div class="text-sm text-gray-500">Score</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-fun gradient-primary text-white px-12 py-4 rounded-2xl font-bold text-xl w-full" onclick="startRaceGame()">
                        <i class="fas fa-play mr-2"></i>
                        Start Racing! üöÄ
                    </button>
                </div>
            `;
        } else if (gameMode === 'daily_challenge') {
            gameContent.innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-6 pulse-slow">üìÖ</div>
                    <h2 class="text-3xl font-bold text-gradient mb-4">${gameData.title}</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">${gameData.description}</p>
                    <div class="glass-morphism p-6 rounded-2xl mb-8">
                        <h3 class="font-bold mb-4">Signs to Master:</h3>
                        <div class="flex flex-wrap gap-3 justify-center mb-4">
                            ${gameData.target_signs.map(sign => `<span class="gradient-primary text-white px-4 py-2 rounded-full text-sm font-bold">${sign}</span>`).join('')}
                        </div>
                        <div class="text-2xl font-bold text-green-600">üéÅ ${gameData.xp_reward} XP Reward!</div>
                    </div>
                    <button class="btn-fun gradient-success text-white px-12 py-4 rounded-2xl font-bold text-xl w-full" onclick="startDailyChallenge()">
                        <i class="fas fa-rocket mr-2"></i>
                        Accept Challenge! üéØ
                    </button>
                </div>
            `;
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function startRealTimeDetection() {
        window.location.href = '/predict/';
    }

    function closeModal() {
        const modal = document.getElementById('gameModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (gameTimer) {
            clearInterval(gameTimer);
            gameTimer = null;
        }
    }

    function startRaceGame() {
        // Simulate game logic with enhanced visuals
        let currentIndex = 0;
        let score = 0;
        let timeLeft = 60;
        
        gameStartTime = Date.now();
        
        gameTimer = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').textContent = timeLeft;
            
            if (timeLeft <= 0) {
                endGame('sign_race', score, (score / gameData.challenge.length) * 100);
            }
        }, 1000);
        
        // Simulate automatic progression for demo
        const progressInterval = setInterval(() => {
            if (currentIndex < gameData.challenge.length - 1) {
                currentIndex++;
                score++;
                const letterElement = document.getElementById('currentLetter');
                letterElement.textContent = gameData.challenge[currentIndex];
                letterElement.classList.add('animate__animated', 'animate__bounceIn');
                document.getElementById('score').textContent = score;
                
                setTimeout(() => {
                    letterElement.classList.remove('animate__animated', 'animate__bounceIn');
                }, 1000);
            } else {
                clearInterval(progressInterval);
                endGame('sign_race', score, 100);
            }
        }, 3000);
    }

    async function endGame(gameMode, score, accuracy) {
        if (gameTimer) {
            clearInterval(gameTimer);
            gameTimer = null;
        }
        
        const timeTaken = Math.floor((Date.now() - gameStartTime) / 1000);
        
        try {
            const response = await fetch('/api/gamification/submit-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify({
                    game_mode: gameMode,
                    score: score,
                    accuracy: accuracy,
                    time_taken: timeTaken
                })
            });

            if (response.ok) {
                const result = await response.json();
                showGameResults(result);
                loadDashboard(); // Refresh dashboard
            }
        } catch (error) {
            console.error('Error submitting score:', error);
        }
    }

    function showGameResults(result) {
        const gameContent = document.getElementById('gameContent');
        gameContent.innerHTML = `
            <div class="text-center animate__animated animate__bounceIn">
                <div class="text-6xl mb-6 animate-bounce">üéâ</div>
                <h2 class="text-3xl font-bold text-gradient mb-6">Awesome Job!</h2>
                <div class="glass-morphism p-8 rounded-2xl mb-8">
                    <div class="text-5xl font-bold text-green-600 mb-4">+${result.xp_earned} XP</div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span>Total XP:</span>
                            <span class="font-bold text-purple-600">${result.total_xp}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Level:</span>
                            <span class="font-bold text-blue-600">${result.level}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Current Streak:</span>
                            <span class="font-bold text-red-600">${result.current_streak} üî•</span>
                        </div>
                    </div>
                </div>
                <button class="btn-fun gradient-primary text-white px-12 py-4 rounded-2xl font-bold text-xl w-full" onclick="closeModal()">
                    <i class="fas fa-rocket mr-2"></i>
                    Continue Learning! üöÄ
                </button>
            </div>
        `;
    }

    function addFunInteractions() {
        // Add hover effects to game cards
        const gameCards = document.querySelectorAll('.cursor-pointer');
        gameCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.classList.add('animate__animated', 'animate__pulse');
            });
            
            card.addEventListener('mouseleave', function() {
                this.classList.remove('animate__animated', 'animate__pulse');
            });
        });

        // Add click effects to buttons
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('click', function() {
                this.classList.add('animate__animated', 'animate__rubberBand');
                setTimeout(() => {
                    this.classList.remove('animate__animated', 'animate__rubberBand');
                }, 1000);
            });
        });
    }

    function updateLearningProgress(data) {
        const progressContainer = document.getElementById('progressContainer');
        progressContainer.innerHTML = '';
        
        // Get local game stats
        const localStats = JSON.parse(localStorage.getItem('gameStats') || '{}');
        const signRaceGames = localStats.signRaceGames || 0;
        const totalCorrect = localStats.totalCorrect || 0;
        const totalQuestions = localStats.totalQuestions || 0;
        const averageAccuracy = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
        
        const progressItems = [
            {
                name: 'ASL Alphabet Recognition',
                progress: Math.min((signRaceGames * 10), 100),
                icon: 'üî§',
                description: `${signRaceGames} games completed`
            },
            {
                name: 'Sign Accuracy',
                progress: averageAccuracy,
                icon: 'üéØ',
                description: `${averageAccuracy}% accuracy (${totalCorrect}/${totalQuestions})`
            },
            {
                name: 'Learning Streak',
                progress: Math.min(((data.user_stats?.current_streak || 0) * 5), 100),
                icon: 'üî•',
                description: `${data.user_stats?.current_streak || 0} day streak`
            },
            {
                name: 'Overall Progress',
                progress: Math.min(((data.user_stats?.xp_points || 0) / 50), 100),
                icon: 'üìà',
                description: `${data.user_stats?.xp_points || 0} XP earned`
            }
        ];
        
        progressItems.forEach((item, index) => {
            const progressItem = document.createElement('div');
            progressItem.className = 'glass-morphism p-6 rounded-2xl animate__animated animate__fadeInUp cursor-pointer hover:scale-105 transition-all duration-300';
            progressItem.style.animationDelay = `${index * 0.2}s`;
            progressItem.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center">
                        <span class="text-2xl mr-3">${item.icon}</span>
                        <div>
                            <span class="font-bold text-gray-800 dark:text-white text-lg">${item.name}</span>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${item.description}</div>
                        </div>
                    </div>
                    <span class="text-sm text-gray-600 dark:text-gray-400 font-medium">${Math.round(item.progress)}%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div class="gradient-primary h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            `;
            progressContainer.appendChild(progressItem);
            
            // Animate progress bar
            setTimeout(() => {
                const progressBar = progressItem.querySelector('.gradient-primary');
                progressBar.style.width = `${item.progress}%`;
            }, 500 + (index * 200));
            
            // Add click interaction
            progressItem.addEventListener('click', () => {
                if (item.name.includes('Alphabet')) {
                    window.location.href = '/sign-race/';
                } else if (item.name.includes('Accuracy')) {
                    window.location.href = '/predict/';
                }
            });
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('gameModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}