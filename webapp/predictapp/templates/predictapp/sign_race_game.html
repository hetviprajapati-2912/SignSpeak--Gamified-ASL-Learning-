{% extends 'predictapp/base_enhanced.html' %}

{% block title %}SignSpeak - Sign Race Challenge! üèÉ‚Äç‚ôÇÔ∏è{% endblock %}

{% block extra_css %}
<style>
    @keyframes redBlink {
        0%, 100% { 
            background: rgba(239, 68, 68, 0.15) !important;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
        }
        50% { 
            background: rgba(239, 68, 68, 0.3) !important;
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.7);
        }
    }
    
    .time-warning {
        animation: redBlink 1.5s ease-in-out infinite !important;
    }
    
    .timer-warning {
        animation: redBlink 1s ease-in-out infinite !important;
        border: 2px solid rgba(239, 68, 68, 0.6) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-12">
    <!-- Game Header -->
    <div class="text-center mb-12 animate__animated animate__fadeInDown">
        <div class="relative inline-block mb-8 px-4">
            <h1 class="text-6xl font-black text-gradient mb-4 floating leading-tight">
                üèÉ‚Äç‚ôÇÔ∏è Sign Race Challenge
            </h1>
            <div class="absolute -top-4 -right-4 text-4xl animate-bounce">‚ö°</div>
            <div class="absolute -bottom-4 -left-4 text-3xl wiggle">üéØ</div>
        </div>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
            üöÄ Look at the ASL sign and type the correct letter as fast as you can! Beat the clock and become a signing champion! ‚ú®
        </p>
    </div>

    <!-- Back to Dashboard Button -->
    <div class="mb-8">
        <a href="/dashboard/" class="btn-fun gradient-secondary text-white px-6 py-3 rounded-2xl font-bold transition-all duration-300 transform hover:scale-105 shadow-xl inline-flex items-center">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Dashboard
        </a>
    </div>

    <!-- Game Container -->
    <div class="max-w-4xl mx-auto">
        <!-- Game Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-morphism rounded-2xl p-6 text-center shadow-xl">
                <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="timeLeft">60</div>
                <div class="text-gray-600 dark:text-gray-400 font-medium">Seconds Left ‚è∞</div>
            </div>
            <div class="glass-morphism rounded-2xl p-6 text-center shadow-xl">
                <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="score">0</div>
                <div class="text-gray-600 dark:text-gray-400 font-medium">Score üéØ</div>
            </div>
            <div class="glass-morphism rounded-2xl p-6 text-center shadow-xl">
                <div class="text-3xl font-bold text-purple-600 dark:text-purple-400" id="streak">0</div>
                <div class="text-gray-600 dark:text-gray-400 font-medium">Streak üî•</div>
            </div>
            <div class="glass-morphism rounded-2xl p-6 text-center shadow-xl">
                <div class="text-3xl font-bold text-red-600 dark:text-red-400" id="accuracy">100%</div>
                <div class="text-gray-600 dark:text-gray-400 font-medium">Accuracy üìä</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="glass-morphism rounded-3xl p-8 shadow-2xl neon-glow text-center mb-8 min-h-[600px] flex flex-col justify-center" id="gameArea">
            <!-- Start Screen -->
            <div id="startScreen">
                <div class="mb-8">
                    <div class="text-8xl mb-6 animate-bounce">üèÅ</div>
                    <h2 class="text-4xl font-bold text-gradient mb-4">Ready to Race?</h2>
                    <p class="text-xl text-gray-600 dark:text-gray-300 mb-8">You'll see ASL hand signs - type the correct letter as fast as you can!</p>
                </div>
                <button onclick="startGame()" class="btn-fun gradient-primary text-white px-12 py-6 rounded-2xl font-bold text-2xl transition-all duration-300 transform hover:scale-105 shadow-2xl neon-glow">
                    <i class="fas fa-play mr-3"></i>
                    Start Racing! üöÄ
                </button>
            </div>

            <!-- Game Screen -->
            <div id="gameScreen" class="hidden">
                <div class="mb-8">
                    <!-- Timer and Skip Row -->
                    <div class="flex justify-between items-center mb-6">
                        <div class="glass-morphism rounded-2xl p-4">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="gameTimer">60</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Seconds Left ‚è∞</div>
                        </div>
                        <button onclick="skipQuestion()" class="btn-fun gradient-warning text-white px-6 py-3 rounded-xl font-bold transition-all duration-300 transform hover:scale-105 shadow-lg">
                            <i class="fas fa-forward mr-2"></i>
                            Skip ‚è≠Ô∏è
                        </button>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">What letter is this ASL sign?</h3>
                    
                    <!-- ASL Sign Display -->
                    <div class="relative inline-block mb-4">
                        <div class="w-80 h-80 mx-auto bg-white dark:bg-gray-800 rounded-3xl shadow-2xl flex items-center justify-center border-4 border-purple-300 dark:border-purple-600">
                            <img id="aslImage" src="" alt="ASL Sign" class="w-72 h-72 object-contain rounded-2xl">
                        </div>
                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-green-400 rounded-full animate-ping"></div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="mb-4">
                        <input type="text" id="answerInput" maxlength="1" 
                               class="w-28 h-28 text-5xl font-black text-center bg-gradient-to-br from-purple-400 to-pink-400 text-white rounded-2xl focus:from-green-400 focus:to-blue-400 focus:outline-none transition-all duration-300 mx-auto block shadow-2xl border-4 border-white/30 placeholder-white/70"
                               placeholder="?" autocomplete="off">
                    </div>
                    
                    <!-- Feedback -->
                    <div id="feedback" class="text-2xl font-bold mb-4 min-h-[2rem]"></div>
                </div>
            </div>

            <!-- Game Over Screen -->
            <div id="gameOverScreen" class="hidden">
                <div class="mb-8">
                    <div class="text-8xl mb-6 animate-bounce">üéâ</div>
                    <h2 class="text-4xl font-bold text-gradient mb-4">Race Complete!</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="glass-morphism p-6 rounded-2xl">
                            <div class="text-4xl font-bold text-green-600 dark:text-green-400" id="finalScore">0</div>
                            <div class="text-gray-600 dark:text-gray-400">Final Score</div>
                        </div>
                        <div class="glass-morphism p-6 rounded-2xl">
                            <div class="text-4xl font-bold text-blue-600 dark:text-blue-400" id="finalAccuracy">0%</div>
                            <div class="text-gray-600 dark:text-gray-400">Accuracy</div>
                        </div>
                        <div class="glass-morphism p-6 rounded-2xl">
                            <div class="text-4xl font-bold text-purple-600 dark:text-purple-400" id="xpEarned">0</div>
                            <div class="text-gray-600 dark:text-gray-400">XP Earned</div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="startGame()" class="btn-fun gradient-primary text-white px-8 py-4 rounded-2xl font-bold text-xl transition-all duration-300 transform hover:scale-105 shadow-xl mr-4">
                            <i class="fas fa-redo mr-2"></i>
                            Play Again! üîÑ
                        </button>
                        <a href="/dashboard/" class="btn-fun gradient-secondary text-white px-8 py-4 rounded-2xl font-bold text-xl transition-all duration-300 transform hover:scale-105 shadow-xl">
                            <i class="fas fa-home mr-2"></i>
                            Back to Dashboard üè†
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let gameState = {
        isPlaying: false,
        timeLeft: 60,
        score: 0,
        streak: 0,
        totalQuestions: 0,
        correctAnswers: 0,
        currentLetter: '',
        timer: null
    };

    const aslSigns = {
        'A': '/static/images/asl/A.jpg',
        'B': '/static/images/asl/B.jpg',
        'C': '/static/images/asl/C.jpg',
        'D': '/static/images/asl/D.jpg',
        'E': '/static/images/asl/E.jpg',
        'F': '/static/images/asl/F.jpg',
        'G': '/static/images/asl/G.jpg',
        'H': '/static/images/asl/H.jpg',
        'I': '/static/images/asl/I.jpg',
        'J': '/static/images/asl/J.jpg',
        'K': '/static/images/asl/K.jpg',
        'L': '/static/images/asl/L.jpg',
        'M': '/static/images/asl/M.jpg',
        'N': '/static/images/asl/N.jpg',
        'O': '/static/images/asl/O.jpg',
        'P': '/static/images/asl/P.jpg',
        'Q': '/static/images/asl/Q.jpg',
        'R': '/static/images/asl/R.jpg',
        'S': '/static/images/asl/S.jpg',
        'T': '/static/images/asl/T.jpg',
        'U': '/static/images/asl/U.jpg',
        'V': '/static/images/asl/V.jpg',
        'W': '/static/images/asl/W.jpg',
        'X': '/static/images/asl/X.jpg',
        'Y': '/static/images/asl/Y.jpg',
        'Z': '/static/images/asl/Z.jpg'
    };

    function startGame() {
        gameState = {
            isPlaying: true,
            timeLeft: 60,
            score: 0,
            streak: 0,
            totalQuestions: 0,
            correctAnswers: 0,
            currentLetter: '',
            timer: null
        };

        showScreen('gameScreen');
        updateStats();
        nextQuestion();
        startTimer();
        
        document.getElementById('answerInput').focus();
    }

    function showScreen(screenId) {
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('gameScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById(screenId).classList.remove('hidden');
    }

    function startTimer() {
        gameState.timer = setInterval(() => {
            gameState.timeLeft--;
            updateStats();
            document.getElementById('gameTimer').textContent = gameState.timeLeft;
            
            // Change color when time is running out
            const timerElement = document.getElementById('gameTimer');
            const gameArea = document.getElementById('gameArea');
            
            const timerContainer = timerElement.parentElement;
            
            if (gameState.timeLeft <= 10) {
                timerElement.className = 'text-3xl font-bold text-red-600 dark:text-red-400 animate-pulse';
                timerContainer.classList.add('timer-warning');
                gameArea.classList.add('time-warning');
            } else if (gameState.timeLeft <= 30) {
                timerElement.className = 'text-3xl font-bold text-yellow-600 dark:text-yellow-400';
                timerContainer.classList.remove('timer-warning');
                gameArea.classList.remove('time-warning');
            } else {
                timerElement.className = 'text-3xl font-bold text-blue-600 dark:text-blue-400';
                timerContainer.classList.remove('timer-warning');
                gameArea.classList.remove('time-warning');
            }
            
            if (gameState.timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    function nextQuestion() {
        const letters = Object.keys(aslSigns);
        gameState.currentLetter = letters[Math.floor(Math.random() * letters.length)];
        
        const aslImage = document.getElementById('aslImage');
        const imageContainer = aslImage.parentElement;
        
        // Clear previous content
        imageContainer.innerHTML = '';
        
        // Create new image element
        const newImage = document.createElement('img');
        newImage.id = 'aslImage';
        newImage.className = 'w-72 h-72 object-contain rounded-2xl';
        newImage.alt = `ASL sign for ${gameState.currentLetter}`;
        
        // Add error handling
        newImage.onerror = function() {
            // If image fails to load, show letter as fallback
            imageContainer.innerHTML = `
                <div class="w-72 h-72 flex items-center justify-center text-9xl font-black text-purple-600 dark:text-purple-400">
                    ${gameState.currentLetter}
                </div>
            `;
        };
        
        newImage.onload = function() {
            // Add loading animation when image loads successfully
            newImage.classList.add('animate__animated', 'animate__zoomIn');
            setTimeout(() => {
                newImage.classList.remove('animate__animated', 'animate__zoomIn');
            }, 1000);
        };
        
        // Set image source
        newImage.src = aslSigns[gameState.currentLetter];
        imageContainer.appendChild(newImage);
        
        document.getElementById('answerInput').value = '';
        document.getElementById('feedback').textContent = '';
    }

    function checkAnswer(answer) {
        gameState.totalQuestions++;
        
        if (answer.toUpperCase() === gameState.currentLetter) {
            gameState.score += 10;
            gameState.correctAnswers++;
            gameState.streak++;
            
            document.getElementById('feedback').innerHTML = '<span class="text-green-500">‚úÖ Correct! +10 points</span>';
            
            // Visual feedback for correct
            const gameArea = document.getElementById('gameArea');
            gameArea.classList.add('animate__animated', 'animate__pulse');
            setTimeout(() => {
                gameArea.classList.remove('animate__animated', 'animate__pulse');
            }, 1000);
            
            // Audio feedback
            playSound('correct');
            
            // Bonus points for streak
            if (gameState.streak >= 5) {
                gameState.score += 5;
                document.getElementById('feedback').innerHTML = '<span class="text-green-500">üî• Streak Bonus! +15 points</span>';
            }
        } else {
            gameState.streak = 0;
            document.getElementById('feedback').innerHTML = `<span class="text-red-500">‚ùå Wrong! It was "${gameState.currentLetter}"</span>`;
            
            // Visual alert
            const gameArea = document.getElementById('gameArea');
            gameArea.classList.add('animate__animated', 'animate__shakeX');
            setTimeout(() => {
                gameArea.classList.remove('animate__animated', 'animate__shakeX');
            }, 1000);
            
            // Audio alert
            playSound('wrong');
        }
        
        updateStats();
        
        setTimeout(() => {
            if (gameState.isPlaying) {
                nextQuestion();
            }
        }, 1500);
    }
    
    function skipQuestion() {
        if (!gameState.isPlaying) return;
        
        gameState.totalQuestions++;
        gameState.streak = 0;
        
        document.getElementById('feedback').innerHTML = `<span class="text-yellow-500">‚è≠Ô∏è Skipped! It was "${gameState.currentLetter}"</span>`;
        
        updateStats();
        
        setTimeout(() => {
            if (gameState.isPlaying) {
                nextQuestion();
            }
        }, 1500);
    }

    function updateStats() {
        document.getElementById('timeLeft').textContent = gameState.timeLeft;
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('streak').textContent = gameState.streak;
        
        const accuracy = gameState.totalQuestions > 0 ? 
            Math.round((gameState.correctAnswers / gameState.totalQuestions) * 100) : 100;
        document.getElementById('accuracy').textContent = accuracy + '%';
    }

    function endGame() {
        gameState.isPlaying = false;
        clearInterval(gameState.timer);
        
        const accuracy = gameState.totalQuestions > 0 ? 
            Math.round((gameState.correctAnswers / gameState.totalQuestions) * 100) : 0;
        const xpEarned = Math.floor(gameState.score * 0.5) + (accuracy > 80 ? 50 : 0);
        
        document.getElementById('finalScore').textContent = gameState.score;
        document.getElementById('finalAccuracy').textContent = accuracy + '%';
        document.getElementById('xpEarned').textContent = xpEarned;
        
        // Update local game stats
        updateLocalGameStats();
        
        showScreen('gameOverScreen');
        
        // Submit score to backend
        submitScore(gameState.score, accuracy, xpEarned);
    }
    
    function updateLocalGameStats() {
        const localStats = JSON.parse(localStorage.getItem('gameStats') || '{}');
        
        localStats.signRaceGames = (localStats.signRaceGames || 0) + 1;
        localStats.totalCorrect = (localStats.totalCorrect || 0) + gameState.correctAnswers;
        localStats.totalQuestions = (localStats.totalQuestions || 0) + gameState.totalQuestions;
        localStats.totalScore = (localStats.totalScore || 0) + gameState.score;
        
        localStorage.setItem('gameStats', JSON.stringify(localStats));
    }

    async function submitScore(score, accuracy, xpEarned) {
        try {
            const response = await fetch('/api/gamification/submit-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                },
                body: JSON.stringify({
                    game_mode: 'sign_race',
                    score: score,
                    accuracy: accuracy,
                    time_taken: 60 - gameState.timeLeft
                })
            });
        } catch (error) {
            console.error('Error submitting score:', error);
        }
    }

    function playSound(type) {
        // Create audio context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === 'correct') {
            oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
        } else if (type === 'wrong') {
            oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.2);
        } else if (type === 'click') {
            oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        }
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
    }

    // Add click sound to all buttons
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            playSound('click');
        }
    });

    // Input handler
    document.addEventListener('DOMContentLoaded', function() {
        const answerInput = document.getElementById('answerInput');
        
        answerInput.addEventListener('input', function(e) {
            if (gameState.isPlaying && e.target.value) {
                checkAnswer(e.target.value);
            }
        });
        
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && gameState.isPlaying && e.target.value) {
                checkAnswer(e.target.value);
            }
        });
    });
</script>
{% endblock %}